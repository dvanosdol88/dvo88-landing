<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Draggable Project Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Include SortableJS library for drag-and-drop -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <!-- Include API client -->
    <script src="api-client.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        h1 {
            font-family: 'Poppins', sans-serif;
        }
        /* Style for the checkbox */
        input[type="checkbox"] {
            width: 1rem; /* Smaller checkbox */
            height: 1rem; /* Smaller checkbox */
            border-radius: 0.25rem;
            flex-shrink: 0;
        }
        /* Style for the text when checkbox is checked */
        .task-item.checked .task-text {
            text-decoration: line-through;
            color: #9ca3af; /* gray-400 */
        }
        .dark .task-item.checked .task-text {
             color: #4b5563; /* gray-600 */
        }
        /* Style for the drag-and-drop placeholder */
        .sortable-ghost {
            opacity: 0.4;
            background-color: #a5f3fc; /* A light cyan color */
            border-radius: 0.75rem; /* rounded-xl */
        }
        /* Task drag and drop styling */
        .task-item {
            cursor: grab;
            transition: all 0.2s;
        }
        .task-item:active {
            cursor: grabbing;
        }
        .task-item.sortable-ghost {
            opacity: 0.4;
            background-color: #dbeafe; /* A light blue color */
            border-radius: 0.375rem;
        }
        /* Add a grab cursor to indicate items are draggable */
        .draggable-card:hover {
            cursor: grab;
        }
        .draggable-card:active {
            cursor: grabbing;
        }
        /* Editable elements styling */
        [contenteditable="true"] {
            outline: none;
            position: relative;
            cursor: text;
            padding: 2px 4px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        [contenteditable="true"]:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        [contenteditable="true"]:focus {
            background-color: rgba(0, 0, 0, 0.1);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
        .dark [contenteditable="true"]:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        .dark [contenteditable="true"]:focus {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .project-title[contenteditable="true"] {
            display: inline-block;
            min-width: 100px;
        }
        .task-text {
            flex: 1;
            min-width: 50px;
        }
        /* Add button styling */
        .add-task-btn {
            margin-top: 0.5rem;
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
            color: #6b7280;
            background: transparent;
            border: 1px dashed #d1d5db;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            text-align: left;
        }
        .add-task-btn:hover {
            color: #3b82f6;
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.05);
        }
        .dark .add-task-btn {
            color: #9ca3af;
            border-color: #4b5563;
        }
        .dark .add-task-btn:hover {
            color: #60a5fa;
            border-color: #60a5fa;
            background-color: rgba(96, 165, 250, 0.1);
        }
        /* Delete button styling */
        .delete-task {
            opacity: 0;
            margin-left: 0.5rem;
            color: #ef4444;
            cursor: pointer;
            font-size: 0.875rem;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            transition: all 0.2s;
        }
        .task-item:hover .delete-task {
            opacity: 1;
        }
        .delete-task:hover {
            background-color: rgba(239, 68, 68, 0.1);
        }
        /* Project links styling */
        .project-links {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }
        .dark .project-links {
            border-top-color: rgba(255, 255, 255, 0.1);
        }
        .project-link {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            color: #6b7280;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 0.375rem;
            text-decoration: none;
            transition: all 0.2s;
        }
        .project-link.has-link {
            color: #374151;
            background: rgba(0, 0, 0, 0.15);
            font-weight: 500;
        }
        .dark .project-link {
            color: #9ca3af;
            background: rgba(255, 255, 255, 0.05);
        }
        .dark .project-link.has-link {
            color: #f9fafb;
            background: rgba(255, 255, 255, 0.15);
        }
        .project-link:hover {
            color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }
        .dark .project-link:hover {
            color: #60a5fa;
            background: rgba(96, 165, 250, 0.1);
        }
        .project-link svg {
            width: 1rem;
            height: 1rem;
        }
        .project-link.edit-links {
            margin-left: auto;
            cursor: pointer;
        }
        /* Links editor modal */
        .links-editor {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            z-index: 1000;
            min-width: 400px;
        }
        .dark .links-editor {
            background: #1f2937;
            color: white;
        }
        .links-editor h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        .links-editor input {
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            background: white;
            color: #111827;
        }
        .dark .links-editor input {
            background: #374151;
            border-color: #4b5563;
            color: white;
        }
        .links-editor-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            margin-top: 1rem;
        }
        .links-editor button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .links-editor .save-btn {
            background: #3b82f6;
            color: white;
            border: none;
        }
        .links-editor .save-btn:hover {
            background: #2563eb;
        }
        .links-editor .cancel-btn {
            background: #e5e7eb;
            color: #374151;
            border: none;
        }
        .dark .links-editor .cancel-btn {
            background: #4b5563;
            color: #e5e7eb;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        /* Strikethrough support */
        .task-text s {
            text-decoration: line-through;
            opacity: 0.7;
        }
        /* Formatting toolbar */
        .format-toolbar {
            position: absolute;
            background: #374151;
            border-radius: 0.375rem;
            padding: 0.25rem;
            display: none;
            gap: 0.25rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }
        .format-toolbar button {
            padding: 0.25rem 0.5rem;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 0.25rem;
            font-size: 0.875rem;
        }
        .format-toolbar button:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        /* Delete project button */
        .delete-project {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 1.75rem;
            height: 1.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: none;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 1.25rem;
            opacity: 0;
            transition: all 0.2s;
        }
        .draggable-card:hover .delete-project {
            opacity: 1;
        }
        .delete-project:hover {
            background: rgba(239, 68, 68, 0.2);
            transform: scale(1.1);
        }
        /* Add project button */
        .add-project-card {
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(59, 130, 246, 0.05);
            border: 2px dashed rgba(59, 130, 246, 0.3);
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        .add-project-card:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.5);
            transform: translateY(-2px);
        }
        .add-project-content {
            text-align: center;
            color: #3b82f6;
        }
        .add-project-content svg {
            width: 3rem;
            height: 3rem;
            margin: 0 auto 0.5rem;
        }
        .dark .add-project-card {
            background: rgba(96, 165, 250, 0.05);
            border-color: rgba(96, 165, 250, 0.3);
        }
        .dark .add-project-card:hover {
            background: rgba(96, 165, 250, 0.1);
            border-color: rgba(96, 165, 250, 0.5);
        }
        .dark .add-project-content {
            color: #60a5fa;
        }
        /* Project color picker */
        .color-picker {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        .color-option {
            width: 2rem;
            height: 2rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: transform 0.2s;
            border: 2px solid transparent;
        }
        .color-option:hover {
            transform: scale(1.1);
        }
        .color-option.selected {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }
        /* Card flip functionality */
        .card-container {
            perspective: 1000px;
            position: relative;
        }
        .card-flipper {
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            width: 100%;
        }
        .card-container.flipped .card-flipper {
            transform: rotateY(180deg);
        }
        .card-front, .card-back {
            backface-visibility: hidden;
            position: relative;
            width: 100%;
        }
        .card-back {
            transform: rotateY(180deg);
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        /* Corner lift effect styling */
        .card-corner-lift {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 0;
            height: 0;
            border-bottom: 20px solid rgba(0, 0, 0, 0.1);
            border-left: 20px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }
        .card-container:hover .card-corner-lift {
            border-bottom-width: 30px;
            border-left-width: 30px;
            border-bottom-color: rgba(0, 0, 0, 0.2);
        }
        .dark .card-corner-lift {
            border-bottom-color: rgba(255, 255, 255, 0.1);
        }
        .dark .card-container:hover .card-corner-lift {
            border-bottom-color: rgba(255, 255, 255, 0.2);
        }
        
        /* Corner lift label */
        .corner-lift-label {
            position: absolute;
            bottom: 0.25rem;
            right: 0.25rem;
            font-size: 0.6rem;
            color: rgba(0, 0, 0, 0.4);
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: none;
            transform: rotate(-45deg);
            transform-origin: bottom right;
            z-index: 11;
        }
        .card-container:hover .corner-lift-label {
            opacity: 1;
            color: rgba(0, 0, 0, 0.6);
        }
        .dark .corner-lift-label {
            color: rgba(255, 255, 255, 0.4);
        }
        .dark .card-container:hover .corner-lift-label {
            color: rgba(255, 255, 255, 0.6);
        }
        /* For Later section styling */
        .for-later-header {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            opacity: 0.8;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-white via-teal-50 to-green-50 dark:from-gray-900 dark:to-slate-800 text-gray-900 dark:text-gray-100 transition-colors duration-300">
    <!-- SVG Icons -->
    <svg style="display: none;">
        <symbol id="link-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
        </symbol>
        <symbol id="github-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
        </symbol>
        <symbol id="render-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/>
        </symbol>
        <symbol id="edit-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
        </symbol>
        <symbol id="plus-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
        </symbol>
        <symbol id="flip-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12a9 9 0 0 1-9 9m9-9a9 9 0 0 0-9-9m9 9H3m9 9a9 9 0 0 1-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 0 1 9-9"></path>
        </symbol>
    </svg>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-gray-800 dark:text-white">My Projects</h1>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Click any text to edit • Select text and press Alt+S for strikethrough • Changes are saved automatically</p>
            <p class="text-gray-500 dark:text-gray-400 mt-2">An overview of my projects and their status. To-do's and fixes will be picked up by my AI agents.</p>
            <button onclick="if(window.autoPopulateLinks) { autoPopulateLinks(); alert('Links populated where available!'); }" class="mt-2 text-xs text-blue-600 dark:text-blue-400 hover:underline">Auto-populate GitHub links</button>
        </header>

        <!-- The ID 'project-grid' is used by SortableJS to enable drag-and-drop -->
        <div id="project-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            
            <!-- Dynamic project cards will be loaded here by JavaScript -->
            
            <!-- Add Project Card -->
            <div class="add-project-card" onclick="addNewProject()">
                <div class="add-project-content">
                    <svg><use href="#plus-icon"></use></svg>
                    <div class="text-lg font-medium">Add New Project</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Links Editor Modal -->
    <div id="links-modal" class="modal-overlay" style="display: none;">
        <div class="links-editor">
            <h3>Edit Project Links</h3>
            <label>
                <div style="margin-bottom: 0.25rem; font-size: 0.875rem;" class="text-gray-600 dark:text-gray-300">Live URL</div>
                <input type="url" id="live-url-input" placeholder="https://example.com">
            </label>
            <label>
                <div style="margin-bottom: 0.25rem; font-size: 0.875rem;" class="text-gray-600 dark:text-gray-300">GitHub Repository</div>
                <input type="url" id="github-url-input" placeholder="https://github.com/username/repo">
            </label>
            <label>
                <div style="margin-bottom: 0.25rem; font-size: 0.875rem;" class="text-gray-600 dark:text-gray-300">Render Dashboard</div>
                <input type="url" id="render-url-input" placeholder="https://dashboard.render.com/...">
            </label>
            <div class="links-editor-buttons">
                <button class="cancel-btn" onclick="closeLinksModal()">Cancel</button>
                <button class="save-btn" onclick="saveProjectLinks()">Save</button>
            </div>
        </div>
    </div>

    <!-- New Project Modal -->
    <div id="new-project-modal" class="modal-overlay" style="display: none;">
        <div class="links-editor">
            <h3>Create New Project</h3>
            <label>
                <div style="margin-bottom: 0.25rem; font-size: 0.875rem;" class="text-gray-600 dark:text-gray-300">Project Name</div>
                <input type="text" id="project-name-input" placeholder="My New Project" class="text-gray-900 dark:text-white">
            </label>
            <label>
                <div style="margin-bottom: 0.25rem; font-size: 0.875rem;" class="text-gray-600 dark:text-gray-300">Choose Color Theme</div>
                <div class="color-picker">
                    <div class="color-option selected" data-color="teal" style="background: linear-gradient(135deg, #14b8a6, #5eead4);"></div>
                    <div class="color-option" data-color="emerald" style="background: linear-gradient(135deg, #10b981, #86efac);"></div>
                    <div class="color-option" data-color="green" style="background: linear-gradient(135deg, #22c55e, #86efac);"></div>
                    <div class="color-option" data-color="cyan" style="background: linear-gradient(135deg, #06b6d4, #67e8f9);"></div>
                    <div class="color-option" data-color="lime" style="background: linear-gradient(135deg, #84cc16, #bef264);"></div>
                    <div class="color-option" data-color="sky" style="background: linear-gradient(135deg, #0ea5e9, #7dd3fc);"></div>
                    <div class="color-option" data-color="purple" style="background: linear-gradient(135deg, #a855f7, #d8b4fe);"></div>
                    <div class="color-option" data-color="pink" style="background: linear-gradient(135deg, #ec4899, #f9a8d4);"></div>
                </div>
            </label>
            <div class="links-editor-buttons">
                <button class="cancel-btn" onclick="closeNewProjectModal()">Cancel</button>
                <button class="save-btn" onclick="createNewProject()">Create Project</button>
            </div>
        </div>
    </div>

    <script>
        // Storage key for persistence
        const STORAGE_KEY = 'dvo88-project-dashboard';
        let currentEditingCard = null;

        // Load saved data from localStorage
        function loadData() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    
                    // Filter out broken template variables
                    const cleanedData = data.filter(project => {
                        return !project.title.includes('${') && 
                               !project.title.includes('projectName') && 
                               !project.title.includes('projectData');
                    });
                    
                    // Save cleaned data if we removed any broken entries
                    if (cleanedData.length !== data.length) {
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(cleanedData));
                        console.log('Removed', data.length - cleanedData.length, 'broken template entries');
                    }
                    
                    return cleanedData;
                } catch (e) {
                    console.error('Error loading saved data:', e);
                }
            }
            return null;
        }

        // Save data to localStorage
        function saveData() {
            try {
                const projects = [];
                const cards = document.querySelectorAll('.draggable-card');
                console.log('Saving', cards.length, 'projects');
                
                cards.forEach((card, index) => {
                const title = card.querySelector('.project-title').innerText;
                const tasks = [];
                const forLaterTasks = [];
                const isFlipped = card.classList.contains('flipped');
                
                // Get front tasks
                card.querySelectorAll('.card-front .task-item').forEach(task => {
                    const checkbox = task.querySelector('input[type="checkbox"]');
                    const text = task.querySelector('.task-text').innerText;
                    const accentColor = checkbox.classList.contains('accent-red-500') ? 'red' : 'blue';
                    tasks.push({
                        text: text,
                        checked: checkbox.checked,
                        accentColor: accentColor
                    });
                });
                
                // Get back tasks (for later)
                card.querySelectorAll('.card-back .task-item').forEach(task => {
                    const checkbox = task.querySelector('input[type="checkbox"]');
                    const text = task.querySelector('.task-text').innerText;
                    forLaterTasks.push({
                        text: text,
                        checked: checkbox.checked
                    });
                });
                
                // Get project links
                const links = {
                    live: card.querySelector('.live-link')?.href || '',
                    github: card.querySelector('.github-link')?.href || '',
                    render: card.querySelector('.render-link')?.href || ''
                };
                
                // Extract just the color gradient classes
                const colorMatch = card.className.match(/from-(\w+)-\d+ to-(\w+)-\d+/);
                const colorName = colorMatch ? colorMatch[1] : 'teal';
                
                projects.push({
                    title: title,
                    tasks: tasks,
                    forLaterTasks: forLaterTasks,
                    links: links,
                    color: colorName,
                    isFlipped: isFlipped,
                    index: index
                });
            });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(projects));
            console.log('Saved to localStorage:', projects.length, 'projects');
            } catch (error) {
                console.error('Error saving data:', error);
                alert('Error saving data: ' + error.message);
            }
        }

        // Add a new task
        function addTask(button, isForLater = false) {
            const card = button.closest('.draggable-card');
            const side = isForLater ? '.card-back' : '.card-front';
            const ul = card.querySelector(`${side} ul`);
            
            const li = document.createElement('li');
            li.className = 'flex items-center text-gray-700 dark:text-gray-300 task-item';
            const accentColor = isForLater ? 'gray' : 'blue';
            li.innerHTML = `
                <input type="checkbox" class="mr-3 accent-${accentColor}-500 bg-transparent border-gray-400 dark:bg-gray-700 focus:ring-2 focus:ring-${accentColor}-500/50">
                <span class="task-text" contenteditable="true">${isForLater ? 'Future task' : 'New task'}</span>
                <span class="delete-task" onclick="deleteTask(this)">×</span>
            `;
            
            ul.appendChild(li);
            
            // Add checkbox listener
            const checkbox = li.querySelector('input[type="checkbox"]');
            checkbox.addEventListener('change', handleCheckboxChange);
            
            // Add contenteditable save listener
            const taskText = li.querySelector('.task-text');
            taskText.addEventListener('blur', saveData);
            taskText.addEventListener('input', saveData);
            
            // Add keyboard event listener for strikethrough
            taskText.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    taskText.blur();
                } else if (e.key === 's' && (e.ctrlKey || e.metaKey)) {
                    e.preventDefault();
                    toggleStrikethrough(taskText);
                }
            });
            
            // Focus on the new task
            taskText.focus();
            selectAllText(taskText);
            
            saveData();
            
            // Reinitialize task sorting for the updated list
            initializeTaskSorting();
        }

        // Delete a task
        function deleteTask(deleteBtn) {
            const taskItem = deleteBtn.closest('.task-item');
            taskItem.remove();
            saveData();
        }

        // Handle checkbox change
        function handleCheckboxChange(e) {
            const checkbox = e.target;
            const taskItem = checkbox.closest('.task-item');
            if (checkbox.checked) {
                taskItem.classList.add('checked');
            } else {
                taskItem.classList.remove('checked');
            }
            saveData();
        }

        // Select all text in an element
        function selectAllText(element) {
            const range = document.createRange();
            range.selectNodeContents(element);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
        }

        // Edit project links
        function editProjectLinks(button) {
            currentEditingCard = button.closest('.draggable-card');
            const modal = document.getElementById('links-modal');
            
            // Get current links
            const liveLink = currentEditingCard.querySelector('.live-link');
            const githubLink = currentEditingCard.querySelector('.github-link');
            const renderLink = currentEditingCard.querySelector('.render-link');
            
            // Populate inputs
            document.getElementById('live-url-input').value = liveLink?.href && liveLink.href !== '#' ? liveLink.href : '';
            document.getElementById('github-url-input').value = githubLink?.href && githubLink.href !== '#' ? githubLink.href : '';
            document.getElementById('render-url-input').value = renderLink?.href && renderLink.href !== '#' ? renderLink.href : '';
            
            modal.style.display = 'block';
        }

        // Close links modal
        function closeLinksModal() {
            document.getElementById('links-modal').style.display = 'none';
            currentEditingCard = null;
        }

        // Save project links
        function saveProjectLinks() {
            if (!currentEditingCard) return;
            
            const liveUrl = document.getElementById('live-url-input').value.trim();
            const githubUrl = document.getElementById('github-url-input').value.trim();
            const renderUrl = document.getElementById('render-url-input').value.trim();
            
            const liveLink = currentEditingCard.querySelector('.live-link');
            const githubLink = currentEditingCard.querySelector('.github-link');
            const renderLink = currentEditingCard.querySelector('.render-link');
            
            // Update links
            if (liveUrl) {
                liveLink.href = liveUrl;
                liveLink.style.display = 'inline-flex';
                liveLink.classList.add('has-link');
            } else {
                liveLink.style.display = 'none';
                liveLink.classList.remove('has-link');
            }
            
            if (githubUrl) {
                githubLink.href = githubUrl;
                githubLink.style.display = 'inline-flex';
                githubLink.classList.add('has-link');
            } else {
                githubLink.style.display = 'none';
                githubLink.classList.remove('has-link');
            }
            
            if (renderUrl) {
                renderLink.href = renderUrl;
                renderLink.style.display = 'inline-flex';
                renderLink.classList.add('has-link');
            } else {
                renderLink.style.display = 'none';
                renderLink.classList.remove('has-link');
            }
            
            saveData();
            closeLinksModal();
        }

        // Delete project
        function deleteProject(button) {
            if (confirm('Are you sure you want to delete this project?')) {
                const card = button.closest('.draggable-card');
                card.remove();
                saveData();
            }
        }

        // Add new project
        function addNewProject() {
            const modal = document.getElementById('new-project-modal');
            modal.style.display = 'block';
            
            // Reset form
            document.getElementById('project-name-input').value = '';
            document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
            document.querySelector('.color-option[data-color="teal"]').classList.add('selected');
        }

        // Close new project modal
        function closeNewProjectModal() {
            document.getElementById('new-project-modal').style.display = 'none';
        }

        // Create new project
        function createNewProject() {
            const projectName = document.getElementById('project-name-input').value.trim();
            if (!projectName) {
                alert('Please enter a project name');
                return;
            }
            
            const selectedColor = document.querySelector('.color-option.selected').dataset.color;
            const colorClasses = {
                teal: 'from-teal-100 to-teal-300 dark:from-teal-900 dark:to-teal-700',
                emerald: 'from-emerald-100 to-emerald-300 dark:from-emerald-900 dark:to-emerald-700',
                green: 'from-green-100 to-green-300 dark:from-green-900 dark:to-green-700',
                cyan: 'from-cyan-100 to-cyan-300 dark:from-cyan-900 dark:to-cyan-700',
                lime: 'from-lime-100 to-lime-300 dark:from-lime-900 dark:to-lime-700',
                sky: 'from-sky-100 to-sky-300 dark:from-sky-900 dark:to-sky-700',
                purple: 'from-purple-100 to-purple-300 dark:from-purple-900 dark:to-purple-700',
                pink: 'from-pink-100 to-pink-300 dark:from-pink-900 dark:to-pink-700'
            };

            const colorClassesBack = {
                teal: 'from-teal-200 to-teal-400 dark:from-teal-800 dark:to-teal-600',
                emerald: 'from-emerald-200 to-emerald-400 dark:from-emerald-800 dark:to-emerald-600',
                green: 'from-green-200 to-green-400 dark:from-green-800 dark:to-green-600',
                cyan: 'from-cyan-200 to-cyan-400 dark:from-cyan-800 dark:to-cyan-600',
                lime: 'from-lime-200 to-lime-400 dark:from-lime-800 dark:to-lime-600',
                sky: 'from-sky-200 to-sky-400 dark:from-sky-800 dark:to-sky-600',
                purple: 'from-purple-200 to-purple-400 dark:from-purple-800 dark:to-purple-600',
                pink: 'from-pink-200 to-pink-400 dark:from-pink-800 dark:to-pink-600'
            };
            
            const textColorClasses = {
                teal: 'text-teal-900 dark:text-teal-100',
                emerald: 'text-emerald-900 dark:text-emerald-100',
                green: 'text-green-900 dark:text-green-100',
                cyan: 'text-cyan-900 dark:text-cyan-100',
                lime: 'text-lime-900 dark:text-lime-100',
                sky: 'text-sky-900 dark:text-sky-100',
                purple: 'text-purple-900 dark:text-purple-100',
                pink: 'text-pink-900 dark:text-pink-100'
            };
            
            // Create new card element with flip structure
            const newCard = document.createElement('div');
            newCard.className = `draggable-card card-container`;
            
            newCard.innerHTML = `
                <div class="card-flipper">
                    <div class="card-front bg-gradient-to-br ${colorClasses[selectedColor]} rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 ease-in-out p-4 relative">
                        <button class="delete-project" onclick="deleteProject(this)" title="Delete project">×</button>
                        <div class="card-corner-lift" onclick="flipCard(this)" title="Flip to see future features"></div>
                        <div class="corner-lift-label">Later...</div>
                        <h2 class="text-xl font-semibold mb-3 ${textColorClasses[selectedColor]} project-title" contenteditable="true">${projectName}</h2>
                        <ul class="space-y-2">
                            <li class="flex items-center text-gray-700 dark:text-gray-300 task-item">
                                <input type="checkbox" class="mr-3 accent-blue-500 bg-transparent border-gray-400 dark:bg-gray-700 focus:ring-2 focus:ring-blue-500/50">
                                <span class="task-text" contenteditable="true">First task</span>
                                <span class="delete-task" onclick="deleteTask(this)">×</span>
                            </li>
                        </ul>
                        <button class="add-task-btn" onclick="addTask(this)">+ Add task</button>
                        <div class="project-links">
                            <a href="#" class="project-link live-link" target="_blank" style="display: none;">
                                <svg><use href="#link-icon"></use></svg>
                                <span>Live</span>
                            </a>
                            <a href="#" class="project-link github-link" target="_blank" style="display: none;">
                                <svg><use href="#github-icon"></use></svg>
                                <span>GitHub</span>
                            </a>
                            <a href="#" class="project-link render-link" target="_blank" style="display: none;">
                                <svg><use href="#render-icon"></use></svg>
                                <span>Render</span>
                            </a>
                            <button class="project-link edit-links" onclick="editProjectLinks(this)">
                                <svg><use href="#edit-icon"></use></svg>
                                <span>Edit Links</span>
                            </button>
                        </div>
                    </div>
                    <div class="card-back bg-gradient-to-br ${colorClassesBack[selectedColor]} rounded-xl shadow-lg p-4 relative">
                        <div class="card-corner-lift" onclick="flipCard(this)" title="Flip back to main tasks"></div>
                        <div class="corner-lift-label">Back</div>
                        <h3 class="for-later-header ${textColorClasses[selectedColor]}">For Later...</h3>
                        <ul class="space-y-2 for-later-list">
                            <li class="flex items-center text-gray-700 dark:text-gray-300 task-item">
                                <input type="checkbox" class="mr-3 accent-gray-500 bg-transparent border-gray-400 dark:bg-gray-700 focus:ring-2 focus:ring-gray-500/50">
                                <span class="task-text" contenteditable="true">Future enhancement</span>
                                <span class="delete-task" onclick="deleteTask(this)">×</span>
                            </li>
                        </ul>
                        <button class="add-task-btn" onclick="addTask(this, true)">+ Add for later</button>
                    </div>
                </div>
            `;
            
            // Insert before the add button
            const addButton = document.querySelector('.add-project-card');
            addButton.parentNode.insertBefore(newCard, addButton);
            
            // Add event listeners to the new elements
            const checkbox = newCard.querySelector('input[type="checkbox"]');
            checkbox.addEventListener('change', handleCheckboxChange);
            
            const editableElements = newCard.querySelectorAll('[contenteditable="true"]');
            editableElements.forEach(element => {
                element.addEventListener('blur', saveData);
                element.addEventListener('input', saveData);
                element.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        element.blur();
                    } else if (e.key === 's' && e.altKey) {
                        e.preventDefault();
                        toggleStrikethrough(element);
                    }
                });
            });
            
            // Save and close modal
            saveData();
            closeNewProjectModal();
            
            // Focus on the new project title
            const titleElement = newCard.querySelector('.project-title');
            titleElement.focus();
            selectAllText(titleElement);
            
            // Initialize task sorting for the new project
            initializeTaskSorting();
            
            // Verify save after a short delay
            setTimeout(() => {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const data = JSON.parse(saved);
                    console.log('Verified save - projects in storage:', data.length);
                } else {
                    console.error('No data found in localStorage after save!');
                }
            }, 100);
        }

        // Flip card function
        function flipCard(button) {
            const container = button.closest('.card-container');
            container.classList.toggle('flipped');
            saveData();
        }

        // Initialize task sorting for all task lists
        function initializeTaskSorting() {
            // Get all task lists (both front and back of cards)
            const taskLists = document.querySelectorAll('.space-y-2');
            
            taskLists.forEach(list => {
                // Skip if it's not a task list or already initialized
                if (!list.querySelector('.task-item') || list.sortableInstance) {
                    return;
                }
                
                // Create sortable instance
                list.sortableInstance = new Sortable(list, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    filter: '.add-task-btn', // Don't make the add button draggable
                    onEnd: function(evt) {
                        saveData(); // Save when tasks are reordered
                    }
                });
            });
        }

        // Toggle strikethrough on selected text
        function toggleStrikethrough(element) {
            const selection = window.getSelection();
            if (!selection.rangeCount) return;
            
            const range = selection.getRangeAt(0);
            const selectedText = range.toString();
            
            if (!selectedText) return;
            
            // Check if we're in a contenteditable element
            if (!element.isContentEditable) return;
            
            // Get the selected HTML
            const fragment = range.cloneContents();
            const tempDiv = document.createElement('div');
            tempDiv.appendChild(fragment);
            
            // Check if already strikethrough
            const hasStrike = tempDiv.querySelector('s') || tempDiv.innerHTML.includes('<s>');
            
            if (hasStrike) {
                // Remove strikethrough
                const newHtml = tempDiv.innerHTML.replace(/<\/?s>/g, '');
                document.execCommand('insertHTML', false, newHtml);
            } else {
                // Add strikethrough
                document.execCommand('insertHTML', false, `<s>${selectedText}</s>`);
            }
            
            saveData();
        }

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', () => {
            // Load saved data
            const savedData = loadData();
            if (savedData && savedData.length > 0) {
                // Clear existing cards and recreate from saved data
                const grid = document.getElementById('project-grid');
                const addProjectCard = document.querySelector('.add-project-card');
                
                // Remove all existing project cards (but not the add button)
                document.querySelectorAll('.draggable-card').forEach(card => card.remove());
                
                // Recreate all cards from saved data
                savedData.forEach(projectData => {
                    const colorClasses = {
                        teal: 'from-teal-100 to-teal-300 dark:from-teal-900 dark:to-teal-700',
                        emerald: 'from-emerald-100 to-emerald-300 dark:from-emerald-900 dark:to-emerald-700',
                        green: 'from-green-100 to-green-300 dark:from-green-900 dark:to-green-700',
                        cyan: 'from-cyan-100 to-cyan-300 dark:from-cyan-900 dark:to-cyan-700',
                        lime: 'from-lime-100 to-lime-300 dark:from-lime-900 dark:to-lime-700',
                        sky: 'from-sky-100 to-sky-300 dark:from-sky-900 dark:to-sky-700',
                        purple: 'from-purple-100 to-purple-300 dark:from-purple-900 dark:to-purple-700',
                        pink: 'from-pink-100 to-pink-300 dark:from-pink-900 dark:to-pink-700'
                    };

                    const colorClassesBack = {
                        teal: 'from-teal-200 to-teal-400 dark:from-teal-800 dark:to-teal-600',
                        emerald: 'from-emerald-200 to-emerald-400 dark:from-emerald-800 dark:to-emerald-600',
                        green: 'from-green-200 to-green-400 dark:from-green-800 dark:to-green-600',
                        cyan: 'from-cyan-200 to-cyan-400 dark:from-cyan-800 dark:to-cyan-600',
                        lime: 'from-lime-200 to-lime-400 dark:from-lime-800 dark:to-lime-600',
                        sky: 'from-sky-200 to-sky-400 dark:from-sky-800 dark:to-sky-600',
                        purple: 'from-purple-200 to-purple-400 dark:from-purple-800 dark:to-purple-600',
                        pink: 'from-pink-200 to-pink-400 dark:from-pink-800 dark:to-pink-600'
                    };
                    
                    const textColorClasses = {
                        teal: 'text-teal-900 dark:text-teal-100',
                        emerald: 'text-emerald-900 dark:text-emerald-100',
                        green: 'text-green-900 dark:text-green-100',
                        cyan: 'text-cyan-900 dark:text-cyan-100',
                        lime: 'text-lime-900 dark:text-lime-100',
                        sky: 'text-sky-900 dark:text-sky-100',
                        purple: 'text-purple-900 dark:text-purple-100',
                        pink: 'text-pink-900 dark:text-pink-100'
                    };
                    
                    const color = projectData.color || 'teal';
                    const card = document.createElement('div');
                    card.className = `draggable-card card-container ${projectData.isFlipped ? 'flipped' : ''}`;
                    
                    // Build front tasks HTML
                    let tasksHTML = '';
                    if (projectData.tasks) {
                        projectData.tasks.forEach(taskData => {
                        const accentClass = taskData.accentColor === 'red' ? 'accent-red-500' : 'accent-blue-500';
                        const focusClass = taskData.accentColor === 'red' ? 'focus:ring-red-500/50' : 'focus:ring-blue-500/50';
                        const checkedClass = taskData.checked ? 'checked' : '';
                        
                        tasksHTML += `
                            <li class="flex items-center text-gray-700 dark:text-gray-300 task-item ${checkedClass}">
                                <input type="checkbox" class="mr-3 ${accentClass} bg-transparent border-gray-400 dark:bg-gray-700 focus:ring-2 ${focusClass}" ${taskData.checked ? 'checked' : ''}>
                                <span class="task-text" contenteditable="true">${taskData.text}</span>
                                <span class="delete-task" onclick="deleteTask(this)">×</span>
                            </li>
                        `;
                        });
                    }
                    
                    // Build for later tasks HTML
                    let forLaterHTML = '';
                    if (projectData.forLaterTasks) {
                        projectData.forLaterTasks.forEach(taskData => {
                            const checkedClass = taskData.checked ? 'checked' : '';
                            
                            forLaterHTML += `
                                <li class="flex items-center text-gray-700 dark:text-gray-300 task-item ${checkedClass}">
                                    <input type="checkbox" class="mr-3 accent-gray-500 bg-transparent border-gray-400 dark:bg-gray-700 focus:ring-2 focus:ring-gray-500/50" ${taskData.checked ? 'checked' : ''}>
                                    <span class="task-text" contenteditable="true">${taskData.text}</span>
                                    <span class="delete-task" onclick="deleteTask(this)">×</span>
                                </li>
                            `;
                        });
                    }
                    
                    // Set up links visibility
                    const showLive = projectData.links?.live && projectData.links.live !== '#' && projectData.links.live !== '';
                    const showGithub = projectData.links?.github && projectData.links.github !== '#' && projectData.links.github !== '';
                    const showRender = projectData.links?.render && projectData.links.render !== '#' && projectData.links.render !== '';
                    
                    card.innerHTML = `
                        <div class="card-flipper">
                            <div class="card-front bg-gradient-to-br ${colorClasses[color]} rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 ease-in-out p-4 relative">
                                <button class="delete-project" onclick="deleteProject(this)" title="Delete project">×</button>
                                <div class="card-corner-lift" onclick="flipCard(this)" title="Flip to see future features"></div>
                                <div class="corner-lift-label">Later...</div>
                                <h2 class="text-xl font-semibold mb-3 ${textColorClasses[color]} project-title" contenteditable="true">${projectData.title}</h2>
                                <ul class="space-y-2">
                                    ${tasksHTML}
                                </ul>
                                <button class="add-task-btn" onclick="addTask(this)">+ Add task</button>
                                <div class="project-links">
                                    <a href="${showLive ? projectData.links.live : '#'}" class="project-link live-link ${showLive ? 'has-link' : ''}" target="_blank" style="${showLive ? '' : 'display: none;'}">
                                        <svg><use href="#link-icon"></use></svg>
                                        <span>Live</span>
                                    </a>
                                    <a href="${showGithub ? projectData.links.github : '#'}" class="project-link github-link ${showGithub ? 'has-link' : ''}" target="_blank" style="${showGithub ? '' : 'display: none;'}">
                                        <svg><use href="#github-icon"></use></svg>
                                        <span>GitHub</span>
                                    </a>
                                    <a href="${showRender ? projectData.links.render : '#'}" class="project-link render-link ${showRender ? 'has-link' : ''}" target="_blank" style="${showRender ? '' : 'display: none;'}">
                                        <svg><use href="#render-icon"></use></svg>
                                        <span>Render</span>
                                    </a>
                                    <button class="project-link edit-links" onclick="editProjectLinks(this)">
                                        <svg><use href="#edit-icon"></use></svg>
                                        <span>Edit Links</span>
                                    </button>
                                </div>
                            </div>
                            <div class="card-back bg-gradient-to-br ${colorClassesBack[color]} rounded-xl shadow-lg p-4 relative">
                                <div class="card-corner-lift" onclick="flipCard(this)" title="Flip back to main tasks"></div>
                                <div class="corner-lift-label">Back</div>
                                <h3 class="for-later-header ${textColorClasses[color]}">For Later...</h3>
                                <ul class="space-y-2 for-later-list">
                                    ${forLaterHTML}
                                </ul>
                                <button class="add-task-btn" onclick="addTask(this, true)">+ Add for later</button>
                            </div>
                        </div>
                    `;
                    
                    // Insert the card before the add button
                    if (addProjectCard) {
                        grid.insertBefore(card, addProjectCard);
                    } else {
                        grid.appendChild(card);
                    }
                });
                
                // Initialize task sorting for all loaded cards
                initializeTaskSorting();
                
                // Ensure the add button is at the end
                if (addProjectCard && addProjectCard.parentNode !== grid) {
                    grid.appendChild(addProjectCard);
                }
            } else {
                // Create initial sample projects if no saved data exists
                const sampleProjects = [
                    {
                        title: "Website Redesign",
                        color: "teal",
                        tasks: [
                            { text: "Finalize new logo concept", checked: false, accentColor: "blue" },
                            { text: "Create wireframes for homepage", checked: false, accentColor: "blue" },
                            { text: "Fix mobile menu bug", checked: false, accentColor: "red" }
                        ],
                        forLaterTasks: [
                            { text: "Add dark mode support", checked: false, accentColor: "gray" }
                        ],
                        links: { live: "", github: "", render: "" },
                        isFlipped: false
                    },
                    {
                        title: "Mobile App Launch",
                        color: "purple",
                        tasks: [
                            { text: "Implement push notifications", checked: false, accentColor: "blue" },
                            { text: "Optimize app performance", checked: false, accentColor: "blue" },
                            { text: "Fix login bug", checked: false, accentColor: "red" }
                        ],
                        forLaterTasks: [
                            { text: "Add biometric authentication", checked: false, accentColor: "gray" }
                        ],
                        links: { live: "", github: "", render: "" },
                        isFlipped: false
                    },
                    {
                        title: "API Integration",
                        color: "cyan",
                        tasks: [
                            { text: "Write documentation for endpoints", checked: false, accentColor: "blue" },
                            { text: "Set up staging environment", checked: false, accentColor: "blue" },
                            { text: "Correct authentication error", checked: false, accentColor: "red" }
                        ],
                        forLaterTasks: [
                            { text: "Add API rate limiting", checked: false, accentColor: "gray" }
                        ],
                        links: { live: "", github: "", render: "" },
                        isFlipped: false
                    }
                ];
                
                // Save sample data and reload
                localStorage.setItem(STORAGE_KEY, JSON.stringify(sampleProjects));
                location.reload();
            }

            // Add event listeners to all checkboxes
            document.querySelectorAll('.task-item input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', handleCheckboxChange);
            });

            // Add save listeners to all contenteditable elements
            document.querySelectorAll('[contenteditable="true"]').forEach(element => {
                element.addEventListener('blur', saveData);
                
                // Prevent newlines in contenteditable and handle strikethrough
                element.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        element.blur();
                    } else if (e.key === 's' && e.altKey) {
                        e.preventDefault();
                        toggleStrikethrough(element);
                    }
                });
                
                // Add input listener for HTML content
                element.addEventListener('input', () => {
                    saveData();
                });
            });

            // Initialize SortableJS on the grid container
            const grid = document.getElementById('project-grid');
            if (grid) {
                new Sortable(grid, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    filter: '.add-project-card', // Don't make the add button draggable
                    onEnd: saveData // Save when cards are reordered
                });
            }
            
            // Initialize SortableJS on task lists
            initializeTaskSorting();
            
            // Add click listener to modal overlays
            document.getElementById('links-modal').addEventListener('click', (e) => {
                if (e.target.id === 'links-modal') {
                    closeLinksModal();
                }
            });
            
            document.getElementById('new-project-modal').addEventListener('click', (e) => {
                if (e.target.id === 'new-project-modal') {
                    closeNewProjectModal();
                }
            });
            
            // Add color picker functionality
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                });
            });
        });
    </script>
    
    <!-- Auto-populate project links based on known mappings -->
    <script src="populate-links.js"></script>
</body>
</html>
